

  
    
  


  




  


  

<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.21-DEV with theme Tranquilpeak 0.4.1-BETA">
    <title>The story of a nil pointer receiver</title>
    <meta name="author" content="Mehdy Khoshnoody">
    <meta name="keywords" content="go, golang, receiver, nil, pointer, development, devops, microservice, cloud, scalability, maintainability">

    <link rel="icon" href="/favicon.png">
    

    
    <meta name="description" content="Let&rsquo;s assume we want to store Gender as an attribute for our users.

">
    <meta property="og:description" content="Let&rsquo;s assume we want to store Gender as an attribute for our users.

">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="The story of a nil pointer receiver">
    <meta property="og:url" content="/2017/10/the-story-of-a-nil-pointer-receiver/">
    <meta property="og:site_name" content="The DevOps">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="The DevOps">
    <meta name="twitter:description" content="Let&rsquo;s assume we want to store Gender as an attribute for our users.

">
    
      <meta name="twitter:creator" content="@mehdy314">
    
    

    
    

    
      <meta property="og:image" content="//www.gravatar.com/avatar/b9faae55e6679d9cf5394b48c6427634?s=640">
    

    
      <meta property="og:image" content="https://mehdy.me/images/2017-10-the-story-of-nil-pointer-receiver.jpg">
    
    
    

    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-fpbzgxsy0kgmdvyrj5ykkg6ratccrk3gocmaqn4xpcjywmv5dteilzucro4f.min.css" />
    
    

    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-105166695-1', 'auto');
ga('send', 'pageview');
</script>

    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/">The DevOps</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="//www.gravatar.com/avatar/b9faae55e6679d9cf5394b48c6427634?s=90" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="//www.gravatar.com/avatar/b9faae55e6679d9cf5394b48c6427634?s=110" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">Mehdy Khoshnoody</h4>
        
          <h5 class="sidebar-profile-bio">A DevOps who cares too much about <strong>maintainability</strong> and <strong>scalability</strong>. Interested in microservices, cloud, big data, security, AI and IoT</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/mehdy" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://stackoverflow.com/users/3654352/mehdy" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-stack-overflow"></i>
      
      <span class="sidebar-button-desc">Stack Overflow</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/mehdy314" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-linkedin"></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/mehdy314" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/mailto:me@mehdy.net">
    
      <i class="sidebar-button-icon fa fa-lg fa-envelope"></i>
      
      <span class="sidebar-button-desc">Email</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/index.xml">
    
      <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      The story of a nil pointer receiver
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2017-10-16T00:00:00Z">
        
  October 16, 2017

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="/categories/go">go</a>
    
  


  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Let&rsquo;s assume we want to store <code>Gender</code> as an attribute for our users.</p>

<p></p>

<p>And since we use PostgreSQL we can define an enum for gender like this:</p>

<pre><code class="language-sql">CREATE TYPE gender_type AS ENUM('MALE', 'FEMALE', 'OTHER');
</code></pre>

<p>Now let&rsquo;s see how should we use <code>gender_type</code> in our code.
I always prefer to have as much similarity as possible between my models and my database design so I create a new type for <code>Gender</code> as I did in database and implement the <code>Scanner</code> interface:</p>

<pre><code class="language-go">package gender

// Gender type is nothing more than a string
type Gender string

import (
	&quot;database/sql/driver&quot;
	&quot;errors&quot;
	&quot;fmt&quot;
)

const (
	MALE Gender = &quot;MALE&quot;
	FEMALE Gender = &quot;FEMALE&quot;
	OTHER Gender = &quot;OTHETR&quot;
)

func (g *Gender) Scan(src interface{}) (err error) {
	switch val := src.(type) {
		case []byte:
			*g = Gender(string(val))
		// OTHER CASES ...
		default:
			err = fmt.Errorf(&quot;unexpected type: %q&quot;, src)
	}
	return
}

func (g Gender) Value() (value driver.Value, err error) {
	if g == MALE || g == FEMALE || g == OTHER {
		return nil, fmt.Errorf(&quot;Invalid Gender value: %q&quot;, g)
	}
	return string(g), nil
}
</code></pre>

<p>Now let&rsquo;s use our <code>Gender</code> type in the user model:</p>

<pre><code class="language-go">package model

type User struct {
	ID int
	Name string
	// ...
	Gender gender.Gender `sql:&quot;type:gender_type&quot;`
}
</code></pre>

<p>and everything works fine now&hellip;except when we want to be able to have <strong>NULL</strong> values for gender and we modify the model to this</p>

<pre><code class="language-go">Gender *gender.Gender `sql:&quot;type:gender_type&quot;`
</code></pre>

<p>Now when we create an empty instance of user model to scan from database the <code>Gender</code> field is <strong>nil</strong> and when the <code>Scan</code> method is called the pointer receiver(g) is <strong>nil</strong> too. And when we try to dereference the g to update its value we receive <code>panic: runtime error: invalid memory address or nil pointer dereference</code>.<br />
The instant solution that comes to mind is to do this:</p>

<pre><code class="language-go">// instead of *g = Gender(string(val))
g = &amp;Gender(string(val))
</code></pre>

<p>But as soon as you find this solution, you find it useless because this is what happens.</p>

<ol>
<li>you create an empty instance of user so the gender field is a nil pointer (a pointer pointing to nothing)</li>
<li>you call the scan method and go sees that you want a pointer receiver, so it creates a <strong>new</strong> pointer pointing the the value of gender(which is currently <strong>nil</strong>)</li>
<li>you create a new <code>Gender</code> instance and put its address in the pointer you receieved.</li>
<li>But this is the <strong>new</strong> pointer that go created for you and the pointer in user model is still untouched</li>
<li>And BOOM!</li>
</ol>

<h1 id="conclusion">Conclusion</h1>

<p>Be really careful with these pointer receivers and as long as you can don&rsquo;t dereference a pointer receiver!<br />
I&rsquo;d be glad to see what do you think of the problem and what&rsquo;s your solution?</p>

<h2 id="p-s">P.S.</h2>

<p>The solution I used was to look other similar types out there and see what they do and here is what they do:
<a href="https://golang.org/src/database/sql/sql.go?s=4291:4610#L151">https://golang.org/src/database/sql/sql.go?s=4291:4610#L151</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://mehdy.me/tags/pointer/">pointer</a>

  <a class="tag tag--primary tag--small" href="https://mehdy.me/tags/nil/">nil</a>

  <a class="tag tag--primary tag--small" href="https://mehdy.me/tags/receiver/">receiver</a>

  <a class="tag tag--primary tag--small" href="https://mehdy.me/tags/go/">Go</a>

  <a class="tag tag--primary tag--small" href="https://mehdy.me/tags/golang/">golang</a>

                  </div>
                
              
            
            
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                <i class="fa fa-angle-left"></i>
                <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
              </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2017/07/copying-commands-from-host-to-vm/" data-tooltip="Copying commands from host to VM">
              
                <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                <i class="fa fa-angle-right"></i>
              </a>
            </li>
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  </div>


            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2017 <a href="https://mehdy.me">Mehdy Khoshnoody</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        
  <div class="post-actions-wrap">
      <nav >
        <ul class="post-actions post-action-nav">
            <li class="post-action">
              
                <a class="post-action-btn btn btn--disabled">
              
                <i class="fa fa-angle-left"></i>
                <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
              </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2017/07/copying-commands-from-host-to-vm/" data-tooltip="Copying commands from host to VM">
              
                <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                <i class="fa fa-angle-right"></i>
              </a>
            </li>
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  </div>


      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="//www.gravatar.com/avatar/b9faae55e6679d9cf5394b48c6427634?s=110" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">Mehdy Khoshnoody</h4>
    
      <div id="about-card-bio">A DevOps who cares too much about <strong>maintainability</strong> and <strong>scalability</strong>. Interested in microservices, cloud, big data, security, AI and IoT</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        SRE <a href="http://cafebazaar.ir">@CafeBazaar</a>
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Iran, Tehran
      </div>
    
  </div>
</div>

    <div id="algolia-search-modal" class="modal-container">
  <div class="modal">
    <div class="modal-header">
      <span class="close-button"><i class="fa fa-close"></i></span>
      <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
        <span class="searchby-algolia-text text-color-light text-small">by</span>
        <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
      </a>
      <i class="search-icon fa fa-search"></i>
      <form id="algolia-search-form">
        <input type="text" id="algolia-search-input" name="search"
          class="form-control input--large search-input" placeholder="Search" />
      </form>
    </div>
    <div class="modal-body">
      <div class="no-result text-color-light text-center">no post found</div>
      <div class="results">
        
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://mehdy.me/2017/10/the-story-of-a-nil-pointer-receiver/">
                <h3 class="media-heading">The story of a nil pointer receiver</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Oct 10, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Let&rsquo;s assume we want to store <code>Gender</code> as an attribute for our users.</p>

<p></p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://mehdy.me/2017/07/copying-commands-from-host-to-vm/">
                <h3 class="media-heading">Copying commands from host to VM</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Jul 7, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I was following an instruction to deploy an application on a virtualbox VM and I wanted to execute the long commands.
By default it’s not possible to copy those command into the VM.
VirtualBox has a shared clipboard feature which I tried to get it working but it didn&rsquo;t happen so I didn’t dig into it and I came up with a funny hack :D
</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://mehdy.me/2017/05/the-battlefield/">
                <h3 class="media-heading">The Battlefield</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>Battlefield is a project that I&rsquo;ve started in <a href="http://tehpug.ir">TehPUG</a>. you can read the story behind it and see how I decided to start this project <a href="2017/05/the-tehpug/">here</a>.
</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://mehdy.me/2017/05/the-tehpug/">
                <h3 class="media-heading">The TehPUG</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  May 5, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>let me introduce <a href="http://tehpug.ir">TehPUG</a>. TehPUG is the Tehran Python Users Group like any other PUG around the world. People who love python or have heard it recently and want to learn more about it. We have meetups every month. Come and join us if you love python too.
</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://mehdy.me/2017/03/the-devops/">
                <h3 class="media-heading">The DevOps</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Mar 3, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"><p>I decided to start bloging again. I saw myself in a new situation with new insights. so I came up with &ldquo;The DevOps&rdquo; blog idea.
</p></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
          <div class="media">
            
            <div class="media-body">
              <a class="link-unstyled" href="https://mehdy.me/post/">
                <h3 class="media-heading">Posts</h3>
              </a>
              <span class="media-meta">
                <span class="media-date text-small">
                  Oct 10, 2017
                </span>
              </span>
              <div class="media-content hide-xs font-merryweather"></div>
            </div>
            <div style="clear:both;"></div>
            <hr>
          </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <p class="results-count text-medium"
         data-message-zero="no post found"
         data-message-one="1 post found"
         data-message-other="{n} posts found">
         6 posts found
      </p>
    </div>
  </div>
</div>
    
  
    
    <div id="cover" style="background-image:url('https://mehdy.me/images/cover-blur.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" integrity="sha256-IFHWFEbU2/+wNycDECKgjIRSirRNIDp2acEB5fvdVRU=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js" integrity="sha256-+mpyNVJsNt4rVXCw0F+pAOiB3YxmHgrbJsx4ecPuUaI=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.js" integrity="sha256-vMxgR/7FtLovVA+IPrR7+xTgIgARH7y9VZQnmmi0HDI=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.js" integrity="sha256-N0qFUh7/9vLvia87dDndewmsgsyYoNkdA212tPc+2NI=" crossorigin="anonymous"></script>


<script src="/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>

  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/mehdy.me\/2017\/10\/the-story-of-a-nil-pointer-receiver\/';
          
            this.page.identifier = '\/2017\/10\/the-story-of-a-nil-pointer-receiver\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'the-devops';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  



    
  </body>
</html>

